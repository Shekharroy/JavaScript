<!DOCTYPE HTML>
<html lang="en">
<head>
<meta name="robots" content="noindex,nofollow" />
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<meta content="width=device-width, initial-scale=1.0, minimum-scale=.5, maximum-scale=1.0, user-scalable=yes" name="viewport" />
<meta http-equiv="X-UA-Compatible" content="IE=10" />
<meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="expires" content="0" />
<meta http-equiv="pragma" content="no-cache" />
<title>DCirrus Export Poll Report Link</title>
<link rel="shortcut icon" type="image/x-icon" href="assets/img/favicon.png?v=1.16">
<link rel="stylesheet" type="text/css" href="assets/css/bootstrap.min.css?v=1.16">
<link rel="stylesheet" type="text/css" href="../common/css/dcerrorpage.css?v=1.16">
<script type="text/javascript">
  	window.onload =function(){
		var cloudURLProtocol = "";
  	  	cloudURLACTDomain = window.location.href;
    	cloudURLACTDomain = cloudURLACTDomain.replace(cloudURLProtocol, "");
    	cloudURLACTDomain = cloudURLACTDomain.substring(0, cloudURLACTDomain.indexOf("/"));
    	cloudURLACT = cloudURLProtocol + cloudURLACTDomain;
    	cloudApiUrlACMS = cloudURLProtocol + cloudURLACTDomain + "/api.acms";
     	document.querySelector('.cont_principal').className= "cont_principal cont_error_active";
	 	var src = fetchLogoo();
		document.getElementById("clogoimg").src = src;
		setTimeout(function(){
    		document.getElementById("clogoimg").style.display="";
    	}, 2000);
        var link = window.location.href;
        var fileType = link.split("?")[1].replace("pollex=Poll_Details_", "").split(".")[1];
        var report = "";
        if(link.indexOf("pollex=") > -1){
            link = link.split("?")[1].replace("pollex=Poll_Details_", "").split(".")[0];
            report = "Poll Details";
        }else if(link.indexOf("voterex=") > -1){
            link = link.split("?")[1].replace("voterex=Poll_voter_list_", "").split(".")[0];
            report = "Voter List";
        }
        var lawfirmId = link.split("_")[2];
        var userId = link.split("_")[1];
        var pollId = link.split("_")[0];
        if(lawfirmId == localStorage._zw && userId == localStorage._zv){
            var jsonInput = {"attribute1":lawfirmId, "attribute2":userId, "attribute3":pollId, "attribute4":fileType, "attribute5":report};
            var type = updateMethod;
            var posturl = cloudApiUrlACMS + "/v1/app/poll/9/action/pollexport/url";
            const a = document.createElement('a');
            var bs = getauthtokenfromlocal();
            a.style = 'display: none';
            document.body.appendChild(a);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', posturl, true);
            xhr.responseType = "blob";
            xhr.timeout = 0;
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader("Authorization", "Bearer " + bs);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status == 200) {
                        var filename = report + "_" + pollId + "_" + userId + "_" + lawfirmId + "." + fileType;
                        var blob = xhr.response;
                        if (navigator.msSaveBlob) {
                            return navigator.msSaveBlob(blob, filename);
                        }
                        const url = URL.createObjectURL(blob);
                        a.href = url;
                        a.download = filename;
                        a.click();
                        URL.revokeObjectURL(url);
                        var msg = report + " downloaded successfully";
                        document.getElementById("h1_msg").append(msg);
                        document.getElementById("downloadsuccess").style.display="";
                    } else {
                        if (!abortingajax) {
                            document.getElementById("diverror").style.display="";
                        }
                    }
                }
            };
            xhr.send(JSON.stringify(jsonInput));
            xhrPool.push(xhr);
        }else{
            document.getElementById("diverror").style.display="";
        }
  	}

  	function fetchLogoo(){
		if (handleNullValue(localStorage._zl) != ""){
			return cloudApiUrlACMS+ '/' +localStorage._zl;
		} else {
			return "assets/img/Dlogobig.png"
		}
	}

	function handleNullValue(inputData){
		if(inputData =='null' || inputData=='NULL' || inputData==null || inputData == undefined || inputData == "undefined" || inputData == defaultLogoPath) return "";
		return inputData;
  	}
</script>
</head>
<body>
<div class="cont_principal">
  	<div>
    	<img src="assets/img/Dlogobig.png"  id="clogoimg" alt="DCirrus big Logo" style="margin-top: 2%; width: 150px; height: 120px;">
		<!--<p id="ltext">Powered by Dcirrus</p>-->
  	</div>
	<div class="cont_error" id="diverror" style="display:none;">
  		<h1>Error in download</h1>
  		<p id="pmsg"></p>
	</div>

	<div class="cont_error" id="downloadsuccess" style="display:none;">
		<h1 id="h1_msg"></h1>
 	</div>
</div>

<script type="text/javascript" src="assets/js/jquery.min.js?v=1.16"></script>
<script type="text/javascript" src="assets/js/bootstrap.min.js?v=1.16"></script>
<script type="text/javascript" src="assets/js/variables.js?v=1.16"></script>
<script type="text/javascript" src="assets/js/common.js?v=1.16"></script>
<script type="text/javascript" src="assets/js/app.js?v=1.16"></script>
<script type="text/javascript" src="assets/js/aes.js?v=1.16"></script>
<script type="text/javascript" src="assets/js/mousedetect.js?v=1.16"></script>
</body>
</html>